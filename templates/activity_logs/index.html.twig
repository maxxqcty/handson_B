{% extends 'base.html.twig' %}

{% block title %}Activity Logs{% endblock %}
{% block header_title %}System Activity Logs{% endblock %}

{% block body %}

{# Aesthetic Orange & Brown Color Presets #}
{% set AF_PRIMARY = 'text-primary' %}
{% set AF_CARD = 'bg-surface-white shadow-subtle rounded-xl' %}
{% set AF_TABLE_HEADER = 'bg-secondary text-sidebar-text' %}
{% set AF_BADGE_ADMIN = 'bg-primary text-white' %}
{% set AF_BADGE_OTHER = 'bg-background-light text-secondary border border-divider' %}

{# Background for the main page area #}
<div class="p-4 md:p-8 space-y-8 min-h-screen bg-background-light text-secondary">

    {# ------------------------------------------------------------- #}
    {# 1. PAGE HEADER WITH SEARCH & FILTERS #}
    {# ------------------------------------------------------------- #}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b border-divider">
        <h1 class="text-3xl font-bold tracking-wide {{ AF_PRIMARY }} mb-3 sm:mb-0 flex items-center gap-2">
            <i data-feather="activity" class="w-7 h-7"></i>
            System Activity Logs
        </h1>

        <div class="flex items-center gap-2 flex-wrap">
            <input
                id="logSearchInput"
                type="text"
                placeholder="Search logs..."
                class="px-3 py-1.5 text-sm bg-background-light border border-divider rounded-lg shadow-sm focus:ring focus:ring-primary focus:border-primary w-full sm:w-auto text-secondary placeholder-text-muted"
            >

            <select id="roleFilter" class="px-3 py-1.5 text-sm bg-background-light border border-divider rounded-lg shadow-sm focus:ring focus:ring-primary focus:border-primary w-full sm:w-auto text-secondary">
                <option value="">All Roles</option>
                <option value="ROLE_ADMIN">Admin</option>
                <option value="GUEST">Guest</option>
            </select>

            <button
                id="clearFilterBtn"
                class="px-4 py-1.5 bg-secondary text-white font-semibold rounded-lg shadow-md hover:bg-primary-dark transition w-full sm:w-auto text-sm border border-secondary hover:border-primary-dark">
                Clear Filters
            </button>
        </div>
    </div>

    {# ------------------------------------------------------------- #}
    {# 2. THEMED TABLE CARD #}
    {# ------------------------------------------------------------- #}
    <div class="{{ AF_CARD }} border border-divider overflow-x-auto">

        <table id="logsTable" class="min-w-full divide-y divide-divider text-sm">

            <thead>
                <tr class="{{ AF_TABLE_HEADER }} uppercase text-xs">
                    <th class="px-6 py-3 font-bold text-left">User</th>
                    <th class="px-6 py-3 font-bold text-left">Role</th>
                    <th class="px-6 py-3 font-bold text-left">Action</th>
                    <th class="px-6 py-3 font-bold text-left">Target Data</th>
                    <th class="px-6 py-3 font-bold text-left">IP Address</th>
                    <th class="px-6 py-3 font-bold text-left">Date & Time</th>
                </tr>
            </thead>

            <tbody id="logsTableBody" class="divide-y divide-divider/50">

                {% for log in logs %}
                    <tr class="hover:bg-background-light/50 transition duration-150">

                        <td class="px-6 py-3 whitespace-nowrap font-semibold text-secondary">
                            {{ log.userId ? log.userId.username : (log.username ?: '-') }}
                        </td>

                        <td class="px-6 py-3 whitespace-nowrap role-cell">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold
                                {% if log.role == 'ROLE_ADMIN' %}
                                    {{ AF_BADGE_ADMIN }}
                                {% else %}
                                    {{ AF_BADGE_OTHER }}
                                {% endif %}
                            ">
                                {{ log.role ?: 'GUEST' }}
                            </span>
                        </td>

                        <td class="px-6 py-3 whitespace-nowrap text-primary font-bold uppercase text-xs">
                            {{ log.action ?: '-' }}
                        </td>

                        <td class="px-6 py-3 whitespace-nowrap truncate max-w-xs text-secondary/70 italic text-xs">
                            {{ log.targetData ?: '-' }}
                        </td>

                        <td class="px-6 py-3 whitespace-nowrap text-xs text-text-muted font-mono">
                            {{ log.ipAddress ?: '-' }}
                        </td>

                        <td class="px-6 py-3 whitespace-nowrap text-xs text-text-muted">
                            {{ log.createdAt ? log.createdAt|date('Y-m-d H:i:s') : '-' }}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-10 text-center text-text-muted bg-background-light">
                            <i data-feather="info" class="inline w-5 h-5 mr-1"></i>
                            No activity logs found.
                        </td>
                    </tr>
                {% endfor %}

            </tbody>

        </table>
    </div>

    {# ------------------------------------------------------------- #}
    {# 3. JS FILTER FUNCTION (KEPT AS IS) #}
    {# ------------------------------------------------------------- #}
    <script>
        // The JavaScript remains the same as it handles functionality, not styling.
        const searchInput = document.getElementById('logSearchInput');
        const roleFilter = document.getElementById('roleFilter');
        const clearBtn = document.getElementById('clearFilterBtn');
        const tableBody = document.getElementById('logsTableBody');
        const rows = Array.from(tableBody.querySelectorAll('tr'));

        function filterLogs() {
            const searchTerm = searchInput.value.toLowerCase();
            const roleTerm = roleFilter.value;

            rows.forEach(row => {
                if (row.querySelector('td[colspan="6"]')) {
                    row.style.display = 'none';
                    return;
                }

                const rowText = row.innerText.toLowerCase();
                const rowRole = row.querySelector('.role-cell span')?.innerText || '';

                const matchesSearch = rowText.includes(searchTerm);
                const matchesRole =
                    roleTerm === '' || rowRole.includes(roleTerm.replace('ROLE_', '').toUpperCase());

                row.style.display = (matchesSearch && matchesRole) ? '' : 'none';
            });
        }

        searchInput.addEventListener('keyup', filterLogs);
        roleFilter.addEventListener('change', filterLogs);

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            roleFilter.value = '';
            filterLogs();
        });
    </script>

</div>

{% endblock %}
